/*
 * @title WET-BOEW Geomap
 * @overview Displays a dynamic map over which information from additional sources can be overlaid.
 * @license wet-boew.github.io/wet-boew/License-en.html / wet-boew.github.io/wet-boew/Licence-fr.html
 * @author @pjackson28
 */
!function(a,b,c,d){"use strict";var e,f,g,h,i="wb-geomap",j="."+i,k=d.doc,l=2e3,m=0,n=0,o=[],p={config:{controls:[],autoUpdateSize:!0,fractionalZoom:!0,theme:null},overlays:[],features:[],tables:[],useScaleLine:!1,useMousePosition:!1,useLegend:!1,useTab:!1,useMapControls:!0,useGeocoder:!1,useGeolocation:!1,useAOI:!1},q=function(e){var j,k,l=e.target,n=l.className,o={};e.currentTarget===l&&(j=a(l),h||(g=d.i18n,h={close:g("close"),colon:g("colon"),hiddenLayer:g("geo-hdnlyr"),toggleLayer:g("geo-tgllyr"),labelSelect:g("geo-lblsel"),select:g("geo-sel"),zoomFeature:g("geo-zmfeat"),zoomin:g("geo-zmin"),zoomout:g("geo-zmout"),zoomworld:g("geo-zmwrld"),baseMapTitle:g("geo-bmapttl"),baseMapURL:g("geo-bmapurl"),baseMapURLTxt:g("geo-bmapurltxt"),scaleline:g("geo-sclln"),mouseposition:g("geo-msepos"),access:g("geo-ally"),accessTitle:g("geo-allyttl"),attribLink:g("geo-attrlnk"),attribTitle:g("geo-attrttl"),ariaMap:g("geo-ariamap"),geoLocationURL:g("geo-locurl-geogratis"),geoCoderPlaceholder:g("geo-loc-placeholder"),geoCoderLabel:g("geo-loc-label"),aoiNorth:g("geo-aoi-north"),aoiEast:g("geo-aoi-east"),aoiSouth:g("geo-aoi-south"),aoiWest:g("geo-aoi-west"),aoiInstructions:g("geo-aoi-instructions"),aoiBtnDraw:g("geo-aoi-btndraw"),aoiBtnClear:g("geo-aoi-btnclear"),aoiBtnClose:g("close"),geolocBtn:g("geo-geoloc-btn"),geolocFail:g("geo-geoloc-fail"),geolocUncapable:g("geo-geoloc-uncapable")}),k={useScaleLine:-1!==n.indexOf("scaleline")?!0:void 0,useMousePosition:-1!==n.indexOf("position")?!0:void 0,useLegend:-1!==n.indexOf("legend"),useTab:-1!==n.indexOf("tab"),useMapControls:-1!==n.indexOf("static")?!1:!0,useGeocoder:-1!==n.indexOf("geocoder")?!0:!1,useGeolocation:-1!==n.indexOf("geolocation")?!0:!1,useAOI:-1!==n.indexOf("aoi")?!0:!1},a.extend(o,p,k,b[i],d.getData(j,i)),j.data({settings:o}),b.Proj4js={Proj:function(a){var c=proj4(b.Proj4js.defs[a]);return c.srsCode=a,c},defs:proj4.defs,transform:proj4},OpenLayers.Lang.setCode(c.documentElement.lang),OpenLayers.ImgPath=d.getPath("/assets")+"/",proj4.defs("EPSG:3978","+proj=lcc +lat_1=49 +lat_2=77 +lat_0=49 +lon_0=-95 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs"),m+=1,f=r(j),o.layersFile?a.ajax({url:o.layersFile,dataType:"script",async:!1,success:function(){a.extend(o,wet_boew_geomap),U(f,o)}}):U(f,o),f.overlays||_(f))},r=function(a){var b={uniqueId:m,mapid:a.attr("id"),map:null,selectControl:null,showAttribNRCan:!1,queryLayers:[],overlays:0,overlaysLoaded:0,overlaysLoading:{}},c=a.find(".wb-geomap-map");return b.gmap=c.attr("id","geomap-map-"+m).height(.8*c.width()),b.glegend=a.find(".wb-geomap-legend").attr("id","geomap-legend-"+m),b.glayers=a.find(".wb-geomap-layers").attr("id","geomap-layers-"+m),b},s=function(a){var b=new OpenLayers.Control.PanZoom;OpenLayers.Util.extend(b,{draw:function(){var a,b=this,c=["zoomin","zoomout","zoomworld"],d=["zoom-plus-mini","zoom-minus-mini","zoom-world-mini"],e=c.length;for(OpenLayers.Control.prototype.draw.apply(b,arguments),b.buttons=[],a=0;a!==e;a+=1)b._addButton(c[a],d[a]+".png");return b.div}}),a.map.addControl(b),t(a)},t=function(a){var b,c,d,e,f,g=a.gmap.find(".olControlPanZoom")[0],i=g.getElementsByTagName("div"),j=i.length;for(g.setAttribute("role","toolbar"),b=0;b!==j;b+=1)c=i[b],d=c.getElementsByTagName("img")[0],d&&(f=c.action,e=h[f],c.setAttribute("aria-label",e),c.setAttribute("title",e),c.setAttribute("role","button"),c.className+=" olControl"+f,c.tabIndex=0,d.setAttribute("alt",e),d.className+=" olControl"+f)},u=function(b){var c=b.id.replace(/\W/g,"_");a("#"+c).addClass("background-highlight"),a("#cb_"+c).prop("checked",!0)},v=function(b){var c=b.id.replace(/\W/g,"_"),d=b.popup;a("#"+c).removeClass("background-highlight"),a("#cb_"+c).prop("checked",!1),d&&d.visible()&&d.hide()},w=function(a){var b=a.layer.map.getControlsByClass("OpenLayers.Control.SelectFeature")[0];a._lastHighlighter?b.unselect(a):(b.select(a),a.layer.popups&&(e&&e.popup&&e.popup.visible()&&e.popup.hide(),a.popup?a.popup.toggle():x(a)))},x=function(a){var b,d,e,g,i,j,k,l,m,n,o,p=a.layer.popupsInfo,q=a.id.replace(/\W/g,"_"),r=h.close,s=h.colon,t=a.layer.map.size,u="<h3>"+c.getElementById(a.layer.name).getAttribute("aria-label")+"</h3>";if(p){m=p.id,n=p.width,o=p.height,b=(m?m:"popup_")+"_"+q,d=o?o:t.h/2,e=n?n:t.w/2,g=n?p.close:!0,u+=p.content;for(i in a.attributes)a.attributes.hasOwnProperty(i)&&0!==i.length&&(l=new RegExp("_"+i,"igm"),u=u.replace(l,a.attributes[i]))}else{b="popup_"+q,d=t.h/2,e=t.w/2,g=!0;for(i in a.attributes)a.attributes.hasOwnProperty(i)&&0!==i.length&&(u+="<p><strong>"+i+s+"</strong><br />"+a.attributes[i]+"</p>")}j=new OpenLayers.Popup.FramedCloud(b,a.geometry.getBounds().getCenterLonLat(),new OpenLayers.Size(e,d),u,null,g,null),j.maxSize=new OpenLayers.Size(e,d),a.popup=j,a.layer.map.addPopup(j),k=c.createElement("span"),k.className="glyphicon glyphicon-remove-circle close_"+q,k.setAttribute("data-map",f.mapid),k.setAttribute("data-layer",a.layer.id),k.setAttribute("data-feature",a.id),k.setAttribute("aria-label",r),k.setAttribute("title",r),k.setAttribute("role","button"),k.setAttribute("tabindex","0"),a.popup.closeDiv.appendChild(k)},y=function(a,b){if(b){var c=a.glayers.find(".wb-geomap-tabs");0!==c.length?c.attr({"class":"wb-tabs auto-height-none",id:"geomap-tabs-"+m}):a.glayers.prepend("<div id='geomap-tabs-"+m+"' class='wb-geomap-tabs wb-tabs auto-height-none' style='width: "+a.glayers.width()+"px;'>")}},z=function(b,c,d,e){return a("<table class='table "+(e?" wb-tables":" table-condensed")+"' aria-label='"+c+"' id='overlay_"+b+"'><caption>"+d+"</caption><thead></thead><tbody></tbody></table>")},A=function(b,c,d,e,f){0!==b.glegend.length&&B(b,c,d,e);var g=b.glayers,i=a("<div class='wb-geomap-table-wrapper'></div>"),j=c[0].id,k=a("<div id='tabs_"+j+"'>"),l=c[0].attributes["aria-label"].value,m=a("<h3>"+l+"</h3>"),n=a("<div id='msg_"+j+"'><p>"+h.hiddenLayer+"</p></div>");f&&0!==a(".wb-geomap-tabs").length?F(b,c,d,e):(k.append(m,i.append(c)),g.append("<div class='col-md-12'>"+k.html()+"</div>")),d||(k.append(n),i.hide())},B=function(b,c,d,e){var f,g,i,j,k,l,m=a(c),n=c[0].id,o=b.glegend;b.glegend&&(f=o.find("fieldset"),0===f.length&&(f=o.append("<fieldset name='legend'><legend class='wb-inv'>"+h.toggleLayer+"</legend></fieldset>")),i=d?"checked='checked'":"",g=o.find("ul"),0===g.length&&(g=a("<ul class='list-unstyled'></ul>").appendTo(f)),j=a("<input type='checkbox' id='cb_"+n+"' class='geomap-lgnd-cbx' value='"+n+"' "+i+" data-map='"+b.mapid+"' data-layer='"+e+"' />"),k=a("<label>",{"for":"cb_"+n,text:m.attr("aria-label")}).prepend(j),l=a("<li class='checkbox geomap-lgnd-layer'>").append(k,"<div id='sb_"+n+"'></div>"),g.append(l))},C=function(b){var c,d,e,f,g,i,j,k,l,m,n,o,p=b.map.layers.length,q=h.colon;for(m=0;m!==p;m+=1)if(f=b.map.layers[m],!f.isBaseLayer&&(d=a("#sb_"+f.name),e="",d.length)){if(g=f.styleMap.styles["default"],i=g.defaultStyle,c=g.rules.length){for(e+="<ul class='list-unstyled'>",n=0;n!==c;n+=1)o=g.rules[n],j=o.filter,k=j.type,"=="===k&&(k=q),l=o.symbolizer,e+="<li><div class='row'><div class='col-md-2'>"+D(l)+"</div><div class='col-md-10'><small>"+j.property+" "+(null!==j.value?k+" "+j.value:j.lowerBoundary+" "+k+" "+j.upperBoundary)+"</small></div></div></li>";e+="</ul>"}else i.fillColor?e+=D(i):i.externalGraphic&&(e+=E(i));d.append(e)}},D=function(a){var b="",c=a.fillColor,d=a.strokeColor,e=a.fillOpacity;return c&&(b+="background-color: "+c+";"),d&&(b+="border-style: solid; border-width: 2px; border-color: "+d+";"),e&&(b+="opacity: "+e+";"),"<div class='geomap-legend-symbol'"+(""!==b?" style='"+b+"'/>":"/>")},E=function(a,b){var c="",d=b?b:"",e=a.graphicOpacity,f=a.pointRadius,g=a.graphicHeight,h=a.graphicWidth;return e&&(c+="opacity: "+e+";"),f?c+="height: "+f+"px; width: "+f+"px;":g&&h&&(c+="height: "+g+"px; width: "+h+"px;"),"<img src='"+a.externalGraphic+"' alt='"+d+(""!==c?"' style='"+c+"' />":"' />")},F=function(b,c,d){var e,f=b.glayers.find(".wb-geomap-tabs"),g=f.find("ul"),i=c[0].id,j=a("<div class='wb-geomap-table-wrapper'></div>").append(c),k=c.attr("aria-label");e=a("<details>",{id:"details-"+i}).append("<summary>"+k+"</summary>",j),g.append("<li><a href='#tabs_"+i+"'>"+k+"</a></li>"),f.append(e),d||(e.append("<div id='msg_"+i+"'><p>"+h.hiddenLayer+"</p></div>"),j.hide())},G=function(a){var b,c,e,f,g,h,i,j,k,l,m,o,p=d.drawColours[n],q=p,r={strokeColor:p,fillColor:q,fillOpacity:.5,pointRadius:5,strokeWidth:.5},s={strokeColor:"#00f",fillColor:"#00f",fillOpacity:.4,strokeWidth:2},t=a.style;if(n+=1,n===d.drawColours.length&&(n=0),t)if(j=t.type,m=t.select,k={select:new OpenLayers.Style(m?m:s)},"rule"===j){for(e=[],i=new OpenLayers.Style,l=t.rule,h=l.length,g=0;g!==h;g+=1)f=l[g],o=f.filter,c={type:OpenLayers.Filter.Comparison[o],property:f.field},"BETWEEN"!==o?c.value=f.value[0]:(c.lowerBoundary=f.value[0],c.upperBoundary=f.value[1]),e.push(new OpenLayers.Rule({filter:new OpenLayers.Filter.Comparison(c),symbolizer:f.init}));i.addRules(e),k["default"]=i}else"unique"!==j&&(k["default"]=new OpenLayers.Style(t.init));else k={"default":new OpenLayers.Style(r),select:new OpenLayers.Style(s)};return b=new OpenLayers.StyleMap(k),t&&"unique"===j&&b.addUniqueValueRules("default",t.field,t.init),b},H=function(a,b,c,d){var e,f,g=b.feature,i=g.attributes,j="head"===b.type,k=g.id.replace(/\W/g,"_");e=j?"<tr><th>"+h.select+"</th>":"<tr id='featureId'>"+L(a,g,k);for(f in i)i.hasOwnProperty(f)&&(e+=j?"<th>"+f+"</th>":"<td>"+i[f]+"</td>");return c&&(j?d&&(e+="<th>"+h.zoomFeature+"</th>"):e+=M(a,b.feature)),e+"</tr>"},I=function(b,e,f,g,h,i){var j,k,l={type:"head",feature:f.features[0]},m=c.getElementById(e.attr("id")),n=m.getElementsByTagName("thead")[0],o=m.getElementsByTagName("tbody")[0],p=b.selectControl,q=f.features,r=q.length,s=/\W/g,t=H(b,l,g,i),u=o.innerHTML;for(k=0;k!==r;k+=1)j=q[k],u+=H(b,{type:"body",id:j.id.replace(s,"_"),feature:j,selectControl:p},g,i);d.ielt9?(a(n).html(t),a(o).html(u)):(a(n).html(t),a(o).html(u))},J=function(a){a.gmap.find(".olTileImage").attr("alt",""),a.overlaysLoaded+=1,a.overlays===a.overlaysLoaded&&(_(a),a.overlays=0,a.overlaysLoaded=0)},K=function(b,e,f,g){var h=e.id.replace(/\W/g,"_"),i=c.getElementById(h),j=L(b,e,h)+i.innerHTML+(g&&f?M(b,e):"");a(i).html(d.ielt9?j:j)},L=function(a,b,c){return"<td><label class='wb-inv' for='cb_"+c+"'>"+h.labelSelect+"</label><input type='checkbox' id='cb_"+c+"' class='geomap-cbx' data-map='"+a.mapid+"' data-layer='"+b.layer.id+"' data-feature='"+b.id+"' /></td>"},M=function(a,b){return"<td><a href='javascript:;' data-map='"+a.mapid+"' data-layer='"+b.layer.id+"' data-feature='"+b.id+"' class='btn btn-default btn-sm geomap-zoomto'>"+h.zoomFeature+"</a></td>"},N=function(a){var b,c=a.gmap.width(),d={name:h.baseMapTitle,url:h.baseMapURL,layer:h.baseMapTitle,matrixSet:"nativeTileMatrixSet",tileSize:new OpenLayers.Size(256,256),format:"image/jpg",style:"default",requestEncoding:"REST",isBaseLayer:!0,isSingleTile:!1,tileOrigin:new OpenLayers.LonLat(-34655800,3931e4),zoomOffset:5,resolutions:[38364.660062653464,22489.62831258996,13229.193125052918,7937.5158750317505,4630.2175937685215,2645.8386250105837,1587.5031750063501,926.0435187537042,529.1677250021168,317.50063500127004,185.20870375074085,111.12522225044451,66.1459656252646,38.36466006265346,22.48962831258996,13.229193125052918,7.9375158750317505,4.6302175937685215],transitionEffect:"resize"};for(c>260&&500>=c?d.zoomOffset=1:c>500&&725>=c?d.zoomOffset=2:c>725&&1175>=c?d.zoomOffset=3:c>1175&&2300>=c&&(d.zoomOffset=4),b=d.zoomOffset-1;-1!==b;b-=1)d.resolutions.shift();a.map.addLayer(new OpenLayers.Layer.WMTS(d)),d.url=h.baseMapURLTxt,d.isBaseLayer=!1,delete d.transitionEffect,a.map.addLayer(new OpenLayers.Layer.WMTS(d))},O=function(){var a={maxExtent:new OpenLayers.Bounds(-275e4,-9e5,36e5,463e4),restrictedExtent:new OpenLayers.Bounds(-285e4,-1e6,37e5,473e4),maxResolution:"auto",projection:"EPSG:3978",units:"m",displayProjection:new OpenLayers.Projection("EPSG:4269"),aspectRatio:.8,fractionalZoom:!1,tileManager:null};return a},P=function(b,c){var d,e,f,g,h=c.basemap,i=h&&0!==h.length;if(i)if(e=h.mapOptions)try{d={maxExtent:new OpenLayers.Bounds(e.maxExtent.split(",")),restrictedExtent:new OpenLayers.Bounds(e.restrictedExtent.split(",")),maxResolution:e.maxResolution,projection:new OpenLayers.Projection(e.projection),units:e.units,displayProjection:new OpenLayers.Projection(e.displayProjection),numZoomLevels:e.numZoomLevels,aspectRatio:e.aspectRatio,fractionalZoom:e.fractionalZoom,tileManager:null}}catch(j){d={projection:new OpenLayers.Projection("EPSG:4326")}}else d={projection:new OpenLayers.Projection("EPSG:4326")};else d=O();f=void 0===d.aspectRatio?.8:d.aspectRatio,b.gmap.height(b.gmap.width()*d.aspectRatio),b.map=new OpenLayers.Map(b.gmap.attr("id"),a.extend(c.config,d)),b.map.controls=[],i?"wms"===h.type?(g=new OpenLayers.Layer.WMS(h.title,h.url,{layers:h.layers,version:h.version,format:h.format},{isBaseLayer:!0}),g.params.srs=d.projection.projCode,b.map.addLayer(g)):"esri"===h.type&&b.map.addLayer(new OpenLayers.Layer.ArcGIS93Rest(h.title,h.url)):(N(b),b.showAttribNRCan=!0)},Q=function(c,e){var f,g=e.overlays,h=g.length;0!==h&&(c.overlays=h,a.each(g,function(h,i){var j=i.type,k=i.title,m=i.visible,n=i.url,o=z(h,k,i.caption,i.datatable);"kml"===j?(f=new OpenLayers.Layer.Vector(k,{strategies:[new OpenLayers.Strategy.Fixed],protocol:new OpenLayers.Protocol.HTTP({url:n,format:new OpenLayers.Format.KML({extractStyles:!i.style,extractAttributes:!0,internalProjection:c.map.getProjectionObject(),externalProjection:new OpenLayers.Projection("EPSG:4269"),read:function(c){var e,f,g,h,j,k,l,m,n=0,o=[],p=i.attributes;for("string"==typeof c&&(d.ie?(l=new b.ActiveXObject("Microsoft.XMLDOM"),l.async=!1,l.loadXML(c),c=l):c=(new DOMParser).parseFromString(c,"text/xml")),e=this.getElementsByTagNameNS(c,"*","Placemark"),h=e.length;n!==h;n+=1){f=e[n],g=a(f),j=new OpenLayers.Feature.Vector,j.geometry=this.parseFeature(f).geometry,k={};for(m in p)p.hasOwnProperty(m)&&(k[p[m]]=g.find(m).text());j.attributes=k,o.push(j)}return o}})}),eventListeners:{featuresadded:function(a){I(c,o,a,i.zoom,i.datatable,e.useMapControls),c.overlaysLoading[k]&&J(c)},loadstart:function(){c.overlaysLoading[k]=!0,setTimeout(function(){c.overlaysLoading[k]&&J(c)},l)}},styleMap:G(g[h])}),f.name="overlay_"+h,f.datatable=i.datatable,f.popupsInfo=i.popupsInfo,f.popups=i.popups,f.visibility=!0,c.queryLayers.push(f),c.map.addLayer(f),A(c,o,m,f.id,i.tab),f.visibility=m):"atom"===j?(f=new OpenLayers.Layer.Vector(k,{strategies:[new OpenLayers.Strategy.Fixed],protocol:new OpenLayers.Protocol.HTTP({url:n,format:new OpenLayers.Format.Atom({read:function(b){var d,e,f,g,h,j,k,l,m,n,o,p,q,r=this.getElementsByTagNameNS(b,"*","entry"),s=[],t=i.attributes,u=new OpenLayers.Projection("EPSG:4326"),v=c.map.getProjectionObject();for(f=0,g=r.length;f!==g;f+=1){d=r[f],e=a(d),q=this.parseFeature(d),h=new OpenLayers.Feature.Vector,o=q.geometry.components[0],"OpenLayers.Geometry.Polygon"===q.geometry.CLASS_NAME&&5===o.components.length?(k=T(o.components[1].x,o.components[1].y,o.components[3].x,o.components[3].y),l=new OpenLayers.Geometry.LinearRing(k),m=new OpenLayers.Geometry.Polygon(l),n=m.transform(u,v),h.geometry=n):h.geometry=this.parseFeature(d).geometry.transform(u,v),j={};for(p in t)t.hasOwnProperty(p)&&(j[t[p]]=e.find(p).text());h.attributes=j,s.push(h)}return s}})}),eventListeners:{featuresadded:function(a){I(c,o,a,i.zoom,i.datatable,e.useMapControls),c.overlaysLoading[k]&&J(c)},loadstart:function(){c.overlaysLoading[k]=!0,setTimeout(function(){c.overlaysLoading[k]&&J(c)},l)}},styleMap:G(g[h])}),f.name="overlay_"+h,f.datatable=i.datatable,f.popupsInfo=i.popupsInfo,f.popups=i.popups,f.visibility=!0,c.queryLayers.push(f),c.map.addLayer(f),A(c,o,m,f.id,i.tab),f.visibility=m):"georss"===j?(f=new OpenLayers.Layer.Vector(k,{strategies:[new OpenLayers.Strategy.Fixed],protocol:new OpenLayers.Protocol.HTTP({url:n,format:new OpenLayers.Format.GeoRSS({read:function(b){var d,e,f,g,h,j,k,l,m,n,o,p,q,r=this.getElementsByTagNameNS(b,"*","item"),s=[],t=i.attributes,u=new OpenLayers.Projection("EPSG:4326"),v=c.map.getProjectionObject();for(f=0,g=r.length;f!==g;f+=1){d=r[f],e=a(d),q=this.createFeatureFromItem(d),m=new OpenLayers.Feature.Vector,o=q.geometry.components[0],"OpenLayers.Geometry.Polygon"===q.geometry.CLASS_NAME&&5===o.components.length?(h=T(o.components[1].x,o.components[1].y,o.components[3].x,o.components[3].y),j=new OpenLayers.Geometry.LinearRing(h),k=new OpenLayers.Geometry.Polygon(j),l=k.transform(u,v),m.geometry=l):m.geometry=this.parseFeature(d).geometry.transform(u,v),n={};for(p in t)t.hasOwnProperty(p)&&(n[t[p]]=e.find(p).text());m.attributes=n,s.push(m)}return s}})}),eventListeners:{featuresadded:function(a){I(c,o,a,i.zoom,i.datatable,e.useMapControls),c.overlaysLoading[k]&&J(c)},loadstart:function(){c.overlaysLoading[k]=!0,setTimeout(function(){c.overlaysLoading[k]&&J(c)},l)}},styleMap:G(g[h])}),f.name="overlay_"+h,f.datatable=i.datatable,f.popupsInfo=i.popupsInfo,f.popups=i.popups,f.visibility=!0,c.queryLayers.push(f),c.map.addLayer(f),A(c,o,m,f.id,i.tab),f.visibility=m):"json"===j?(f=new OpenLayers.Layer.Vector(k,{strategies:[new OpenLayers.Strategy.Fixed],protocol:new OpenLayers.Protocol.Script({url:n,params:i.params,format:new OpenLayers.Format.GeoJSON({internalProjection:c.map.getProjectionObject(),externalProjection:new OpenLayers.Projection("EPSG:4269"),read:function(a){var b,d,e,f,g,h,j,k,l,m,n,o=i.root,p=a[o]?a[o]:a,q=[],r=i.attributes,s=new OpenLayers.Projection("EPSG:4326"),t=c.map.getProjectionObject();for(d=0,e=p.length;d!==e;d+=1){b=p[d],f=new OpenLayers.Feature.Vector,n=b.geometry.coordinates[0],"Polygon"===b.geometry.type&&5===n.length?(j=T(n[1][0],n[1][1],n[3][0],n[3][1]),k=new OpenLayers.Geometry.LinearRing(j),l=new OpenLayers.Geometry.Polygon(k),m=l.transform(s,t),f.geometry=m):f.geometry=this.parseGeometry(b.geometry),g={};for(h in r)r.hasOwnProperty(h)&&(g[r[h]]=b[h]);f.attributes=g,f.geometry&&q.push(f)}return q}})}),eventListeners:{featuresadded:function(a){I(c,o,a,i.zoom,i.datatable,e.useMapControls),c.overlaysLoading[k]&&J(c)},loadstart:function(){c.overlaysLoading[k]=!0,setTimeout(function(){c.overlaysLoading[k]&&J(c)},l)}},styleMap:G(g[h])}),f.name="overlay_"+h,f.datatable=i.datatable,f.popupsInfo=i.popupsInfo,f.popups=i.popups,f.visibility=!0,c.queryLayers.push(f),c.map.addLayer(f),A(c,o,m,f.id,i.tab),f.visibility=m):"geojson"===j&&(f=new OpenLayers.Layer.Vector(k,{strategies:[new OpenLayers.Strategy.Fixed],protocol:new OpenLayers.Protocol.Script({url:n,params:i.params,format:new OpenLayers.Format.GeoJSON({internalProjection:c.map.getProjectionObject(),externalProjection:new OpenLayers.Projection("EPSG:4269"),read:function(a){var b,d,e,f,g,h,j,k,l,m,n,o=a.features,p=[],q=i.attributes,r=new OpenLayers.Projection("EPSG:4326"),s=c.map.getProjectionObject();for(b=0,d=o.length;b!==d;b+=1){e=o[b],f=new OpenLayers.Feature.Vector,n=e.geometry.coordinates[0],"Polygon"===e.geometry.type&&5===n.length?(j=T(n[1][0],n[1][1],n[3][0],n[3][1]),l=new OpenLayers.Geometry.LinearRing(j),k=new OpenLayers.Geometry.Polygon(l),m=k.transform(r,s),f.geometry=m):f.geometry=this.parseGeometry(e.geometry),g={};for(h in q)q.hasOwnProperty(h)&&(g[q[h]]=e.properties[h]);f.attributes=g,f.geometry&&p.push(f)}return p}})}),eventListeners:{featuresadded:function(a){I(c,o,a,i.zoom,i.datatable,e.useMapControls),c.overlaysLoading[k]&&J(c)},loadstart:function(){c.overlaysLoading[k]=!0,setTimeout(function(){c.overlaysLoading[k]&&J(c)},l)}},styleMap:G(g[h])}),f.name="overlay_"+h,f.datatable=i.datatable,f.popupsInfo=i.popupsInfo,f.popups=i.popups,f.visibility=!0,c.queryLayers.push(f),c.map.addLayer(f),A(c,o,m,f.id,i.tab),f.visibility=m)}))},R=function(b,d,e,f){var g,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,C,D,E,F,H,I,J,K,L,M="<th>"+h.zoomFeature+"</th>",N="<th>"+h.select+"</th>",O=new OpenLayers.Format.WKT({internalProjection:f,externalProjection:e}),P=/<\/?[^>]+>/gi,Q=/\W/g;for(K=d.tables.length-1;-1!==K;K-=1){for(k=c.getElementById(d.tables[K].id),j=a(k),j.wrap("<div class='wb-geomap-table-wrapper'></div>"),i=j.parents(".wb-geomap-table-wrapper"),l=d.tables[K],m=[],o=new OpenLayers.Layer.Vector(j.find("caption").text(),{styleMap:G(l)}),p=k.getElementsByTagName("th"),r=k.getElementsByTagName("tr"),s=r.length,t=d.useMapControls,L=d.tables[K].visible===!1?!1:!0,q=p.length-1;-1!==q;q-=1)m[q]=p[q].innerHTML.replace(P,"");for(n=j.find("thead tr"),l.zoom&&t&&n.append(M),n.prepend(N),s=r.length-1;-1!==s;s-=1){for(u={},v=r[s],w=v.getAttribute("data-type"),y=v.getElementsByTagName("td"),z=y.length-1;-1!==z;z-=1)C=y[z],D=C.getElementsByTagName("script")[0],D&&D.parentNode.removeChild(D),u[m[z]]=C.innerHTML;if(null!==w){if("bbox"===w){for(E=v.getAttribute("data-geometry").split(","),H=T(E[0],E[1],E[2],E[3]),I="",J=H.length-1;-1!==J;J-=1)I+=H[J].x+" "+H[J].y+", ";I=I.slice(0,-2),F="POLYGON (("+I+"))"}else"wkt"===w&&(F=v.getAttribute("data-geometry"));x=O.read(F),v.setAttribute("id",x.id.replace(Q,"_")),x.attributes=u,o.addFeatures([x])}}o.id="#"+l.id,o.datatable=l.datatable,o.popupsInfo=l.popupsInfo,o.popups=l.popups,o.name=l.id,b.map.addLayer(o),b.queryLayers.push(o),o.visibility=L,l.tab?A(b,j,L,o.id,l.tab):b.glegend&&B(b,j,L,o.id),g=a("#msg_"+l.id),0===g.length&&i.after("<div id='msg_"+l.id+"'><p>"+h.hiddenLayer+"</p></div>"),L?a("#msg_"+l.id).fadeOut():a("#msg_"+l.id).fadeIn(),L?i.fadeIn():i.fadeOut()}},S=function(a,b){var d,e,f,g,i,j,k,l,m,n,o,p,q,r=a.gmap,t=a.map,x=h.mouseposition,y=h.scaleline,z=b.useMapControls,A=b.tables,B=A.length,C=a.queryLayers,D=C.length;for(a.selectControl=new OpenLayers.Control.SelectFeature(a.queryLayers,{onSelect:u,onUnselect:v,clickFeature:w}),t.addControl(a.selectControl),a.selectControl.activate(),o=0;o!==B;o+=1)for(i=A[o],j="#"+i.id,n=i.zoom,p=0;p!==D;p+=1)if(k=C[p],k.id===j)for(l=k.features,m=l.length,q=0;q!==m;q+=1)K(a,l[q],n,z);z&&(b.useMousePosition&&(t.addControl(new OpenLayers.Control.MousePosition),d=t.getControlsByClass("OpenLayers.Control.MousePosition")[0].div,d.setAttribute("aria-label",x),d.setAttribute("title",x)),b.useScaleLine&&(t.addControl(new OpenLayers.Control.ScaleLine),e=t.getControlsByClass("OpenLayers.Control.ScaleLine")[0].div,e.setAttribute("aria-label",y),e.setAttribute("title",y)),t.addControl(new OpenLayers.Control.Navigation({zoomWheelEnabled:!0})),t.addControl(new OpenLayers.Control.KeyboardDefaults),t.getControlsByClass("OpenLayers.Control.KeyboardDefaults")[0].deactivate(),r.attr({tabindex:"0","data-map":a.mapid}),s(a),r.before("<details id='geomap-details-"+a.uniqueId+"' class='wb-geomap-detail' style='width:"+(r.width()-10)+"px;'><summary>"+h.accessTitle+"</summary><p>"+h.access+"</p></details>")),(a.showAttribNRCan||b.attribution)&&(t.addControl(new OpenLayers.Control.Attribution),a.showAttribNRCan?(f=c.createElement("a"),f.setAttribute("href",h.attribLink),g="©"+h.attribTitle):b.attribution.href?(f=c.createElement("a"),f.setAttribute("href",b.attribution.href),g=b.attribution.text):(f=c.createElement("p"),g=b.attribution.text),f.appendChild(c.createTextNode(g)),t.getControlsByClass("OpenLayers.Control.Attribution")[0].div.appendChild(f)),t.zoomToMaxExtent()},T=function(a,b,c,d){var e,f=parseFloat(a),g=parseFloat(b),h=parseFloat(c),i=parseFloat(d),j=[];if(0===f.length||0===g.length||0===h.length||0===i.length)return!1;for(-180===f&&(f+=.1),180===h&&(h=-5),90===i&&(i-=3),-90===g&&(g=35),e=f;h>e;e+=.5)j.push(new OpenLayers.Geometry.Point(e,g));for(j.push(new OpenLayers.Geometry.Point(h,g)),e=h;e>f;e-=.5)j.push(new OpenLayers.Geometry.Point(e,i));return j.push(new OpenLayers.Geometry.Point(f,i)),j.push(new OpenLayers.Geometry.Point(f,g)),j},U=function(a,b){P(a,b),a.locStyle=new OpenLayers.Style({pointRadius:10,strokeColor:"#ff0000",fillColor:"#333333"}),a.locLayer=new OpenLayers.Layer.Vector("Location Features",{styleMap:new OpenLayers.StyleMap({pointRadius:10,graphicName:"cross",strokeWidth:4,strokeOpacity:.6,strokeColor:"#FF0033",fillColor:"#FF0033",fillOpacity:0})}),a.map.addLayer(a.locLayer);var c=new OpenLayers.Projection("EPSG:4326"),d=a.map.getProjectionObject();a.selectControl=new OpenLayers.Control.SelectFeature,y(a,b.useTab),R(a,b,c,d),Q(a,b),S(a,b),b.useGeocoder&&(Y(a),b.useAOI&&X(a)),b.useGeolocation&&Z(a),a.gmap.attr({role:"dialog","aria-label":h.ariaMap})},V=function(){var a,b,c={};for(b=o.length-1;-1!==b;b-=1)a=o[b],c[a.id]=a;return c},W=function(a){var b,c;for(c=o.length-1;-1!==c;c-=1)if(b=o[c],b.id===a)return b},X=function(b){b.drawControl=new OpenLayers.Control.DrawFeature(b.locLayer,OpenLayers.Handler.RegularPolygon,{handlerOptions:{sides:4,irregular:!0},eventListeners:{featureadded:function(c){var d=new OpenLayers.Projection("EPSG:4326"),e=b.map.getProjectionObject(),f=c.feature.geometry.getBounds(),g=f.transform(e,d);a("#geomap-aoi-extent-"+b.uniqueId).val(f.toString()),a("#geomap-aoi-extent-lonlat-"+b.uniqueId).val(g.toString()),a("#geomap-aoi-minx-"+b.uniqueId).val(g.toArray()[0].toFixed(6)),a("#geomap-aoi-miny-"+b.uniqueId).val(g.toArray()[1].toFixed(6)),a("#geomap-aoi-maxx-"+b.uniqueId).val(g.toArray()[2].toFixed(6)),a("#geomap-aoi-maxy-"+b.uniqueId).val(g.toArray()[3].toFixed(6)),a("#geomap-aoi-btn-draw-"+b.uniqueId).click()}}}),b.map.addControl(b.drawControl),b.gmap.before("<div class='geomap-aoi panel panel-default'><div id='geomap-aoi-"+b.uniqueId+"' class='panel-body'></div></div>");var c=a("#geomap-map-"+b.uniqueId);c.append("<button id='geomap-aoi-toggle-mode-draw-"+b.uniqueId+"' href='#' class='btn btn-sm geomap-geoloc-aoi-btn' title='"+h.aoiBtnDraw+"'><i class='glyphicon glyphicon-edit'></i><span class='wb-inv'> "+h.aoiBtnDraw+"</span></button>"),a("#geomap-aoi-"+b.uniqueId).parent().hide(),a("#geomap-aoi-"+b.uniqueId).append("<fieldset id='form-aoi-"+b.uniqueId+"'><legend tabindex='-1'>"+h.aoiInstructions+"</legend><div class='row'><div class='col-md-2'><label for='geomap-aoi-maxy-"+b.uniqueId+"' class='input-sm control-label wb-inv'>"+h.aoiNorth+"</label><div class='input-group input-group-sm'><span class='input-group-addon'>"+h.aoiNorth.charAt(0)+"</span><input type='number' id='geomap-aoi-maxy-"+b.uniqueId+"' placeholder='90' class='form-control input-sm' min='-90' max='90' step='0.000001'/> </div></div><div class='col-md-2'><label for='geomap-aoi-maxx-"+b.uniqueId+"' class='input-sm control-label wb-inv'>"+h.aoiEast+"</label><div class='input-group input-group-sm'><span class='input-group-addon'>"+h.aoiEast.charAt(0)+"</span><input type='number' id='geomap-aoi-maxx-"+b.uniqueId+"' placeholder='180' class='form-control input-sm' min='-180' max='180' step='0.000001'/> </div></div><div class='col-md-2'><label for='geomap-aoi-miny-"+b.uniqueId+"' class='input-sm control-label wb-inv'>"+h.aoiSouth+"</label><div class='input-group input-group-sm'><span class='input-group-addon'>"+h.aoiSouth.charAt(0)+"</span><input type='number' id='geomap-aoi-miny-"+b.uniqueId+"' placeholder='-90' class='form-control input-sm' min='-90' max='90' step='0.000001'/> </div></div><div class='col-md-2'><label for='geomap-aoi-minx-"+b.uniqueId+"' class='input-sm control-label wb-inv'>"+h.aoiWest+"</label><div class='input-group input-group-sm'><span class='input-group-addon'>"+h.aoiWest.charAt(0)+"</span><input type='number' id='geomap-aoi-minx-"+b.uniqueId+"' placeholder='-180' class='form-control input-sm' min='-180' max='180' step='0.000001'/> </div></div><div class='col-md-4'><button class='btn btn-default btn-sm' id='geomap-aoi-btn-draw-"+b.uniqueId+"'>"+h.aoiBtnDraw+"</button> <button class='btn btn-default btn-sm' id='geomap-aoi-btn-clear-"+b.uniqueId+"'>"+h.aoiBtnClear+"</button> </div></div><input type='hidden' id='geomap-aoi-extent-"+b.uniqueId+"'/><input type='hidden' id='geomap-aoi-extent-lonlat-"+b.uniqueId+"'/></fieldset></div><div class='clear'></div>"),k.on("click","#geomap-aoi-toggle-mode-draw-"+b.uniqueId,function(c){c.preventDefault();var d=b.map.getControlsByClass("OpenLayers.Control.DrawFeature")[0],e=d.active,f=a("#geomap-aoi-"+b.uniqueId);e?d.deactivate():d.activate(),f.parent().slideToggle(),a(this).toggleClass("active"),e||f.find("legend").trigger("setfocus.wb"),b.map.updateSize()}),k.on("click","#geomap-aoi-btn-draw-"+b.uniqueId,function(c){c.preventDefault(),a("#geomap-aoi-extent-"+b.uniqueId).val(""),a("#geomap-aoi-extent-lonlat-"+b.uniqueId).val(""),a("#geomap-aoi-minx-"+b.uniqueId).parent().removeClass("has-error"),a("#geomap-aoi-maxx-"+b.uniqueId).parent().removeClass("has-error"),a("#geomap-aoi-maxy-"+b.uniqueId).parent().removeClass("has-error"),a("#geomap-aoi-miny-"+b.uniqueId).parent().removeClass("has-error"),b.locLayer.removeAllFeatures();var d,e,f,g,h,i,j,k=parseFloat(a("#geomap-aoi-minx-"+b.uniqueId).val()),l=parseFloat(a("#geomap-aoi-miny-"+b.uniqueId).val()),m=parseFloat(a("#geomap-aoi-maxx-"+b.uniqueId).val()),n=parseFloat(a("#geomap-aoi-maxy-"+b.uniqueId).val()),o=!0;return(!k||-180>k||k>180)&&(a("#geomap-aoi-minx-"+b.uniqueId).parent().addClass("has-error"),o=!1),(!m||-180>m||m>180)&&(a("#geomap-aoi-maxx-"+b.uniqueId).parent().addClass("has-error"),o=!1),(!n||-90>n||n>90)&&(a("#geomap-aoi-maxy-"+b.uniqueId).parent().addClass("has-error"),o=!1),(!l||-90>l||l>90)&&(a("#geomap-aoi-miny-"+b.uniqueId).parent().addClass("has-error"),o=!1),o===!1?!1:(d=T(k,l,m,n),e=new OpenLayers.Geometry.LinearRing(d),f=new OpenLayers.Geometry.Polygon(e),g=new OpenLayers.Projection("EPSG:4326"),h=b.map.getProjectionObject(),i=f.transform(g,h),j=new OpenLayers.Feature.Vector(i),b.locLayer.addFeatures([j]),b.map.zoomToExtent(b.locLayer.getDataExtent()),a("#geomap-aoi-extent-"+b.uniqueId).val(i.getBounds().toBBOX()).trigger("change"),void a("#geomap-aoi-extent-lonlat-"+b.uniqueId).val(k+", "+l+", "+m+", "+n).trigger("change"))}),k.on("click","#geomap-aoi-btn-clear-"+b.uniqueId,function(c){c.preventDefault(),a("#geomap-aoi-extent-"+b.uniqueId).val(""),a("#geomap-aoi-extent-lonlat-"+b.uniqueId).val(""),a("#geomap-aoi-minx-"+b.uniqueId).val("").parent().removeClass("has-error"),a("#geomap-aoi-miny-"+b.uniqueId).val("").parent().removeClass("has-error"),a("#geomap-aoi-maxx-"+b.uniqueId).val("").parent().removeClass("has-error"),a("#geomap-aoi-maxy-"+b.uniqueId).val("").parent().removeClass("has-error"),b.locLayer.removeAllFeatures()})},Y=function(b){var c,d,e=a("#geomap-map-"+b.uniqueId);e.append("<div class='geomap-geoloc form-inline'><label for='wb-geomap-geocode-search-"+b.uniqueId+"' class='wb-inv'>"+h.geoCoderLabel+"</label><input type='text' class='form-control input-sm opct-90 pull-right' name='wb-geomap-geocode-search-"+b.uniqueId+"' id='wb-geomap-geocode-search-"+b.uniqueId+"' list='wb-geomap-geocode-results-"+b.uniqueId+"' autocomplete='off' placeholder='"+h.geoCoderPlaceholder+"' /><datalist id='wb-geomap-geocode-results-"+b.uniqueId+"'></datalist></div>"),a("#wb-geomap-geocode-search-"+b.uniqueId).trigger("wb-init.wb-datalist"),k.on("keypress","#wb-geomap-geocode-search-"+b.uniqueId,function(c){if(13===c.keyCode){var d,e,f,g,h,i,j,k,l,m,n,o,p,q=new OpenLayers.Projection("EPSG:4326"),r=b.map.getProjectionObject();if(b.locLayer.destroyFeatures(),o=a("#wb-geomap-geocode-search-"+b.uniqueId).val(),!o)return a("#wb-geomap-geocode-search-"+b.uniqueId).parent().addClass("has-error"),void setTimeout(function(){a("#wb-geomap-geocode-search-"+b.uniqueId).parent().removeClass("has-error")},5e3);d=a("#wb-geomap-geocode-results-"+b.uniqueId+" option").filter(function(){return this.value===o}).data("bbox"),l=a("#wb-geomap-geocode-results-"+b.uniqueId+" option").filter(function(){return this.value===o}).data("lat-lon"),f={bbox:d,lonlat:l},null!=f.bbox?(e=new OpenLayers.Bounds.fromString(f.bbox),g=T(e.left,e.bottom,e.right,e.top),n=new OpenLayers.Geometry.LinearRing(g),i=new OpenLayers.Geometry.Polygon(n),j=i.transform(q,r),h=new OpenLayers.Feature.Vector(j),b.locLayer.addFeatures([h]),b.map.zoomToExtent(j.getBounds())):null!=f.lonlat&&(p=0===b.map.getZoom()?.85*b.map.numZoomLevels:b.map.getZoom(),k=new OpenLayers.LonLat(f.lonlat.split(",")).transform(q,r),m=new OpenLayers.Geometry.Point(k.lon,k.lat),h=new OpenLayers.Feature.Vector(m),b.locLayer.addFeatures([h]),b.map.setCenter(k,p))
}}),k.on("keyup","#wb-geomap-geocode-search-"+b.uniqueId,function(e){var f,g,i,j,k,l=a("<datalist id='wb-geomap-geocode-results-"+b.uniqueId+"'></datalist>"),m=[];a(this).parent().removeClass("has-error"),f=a(this).val().trim(),k=e.which,""===f||f.length<=2||13===k||(c&&c.abort(),clearTimeout(d),d=setTimeout(function(){c=a.get(h.geoLocationURL,{q:f+"*"},function(c){if(m=["<!--[if lte IE 9]><select><![endif]-->"],c.length)for(var d=0,e=c.length;e>d;d++)j=c[d].title.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),g=c[d].bbox?c[d].bbox[0]+", "+c[d].bbox[1]+", "+c[d].bbox[2]+", "+c[d].bbox[3]:null,i=c[d].geometry&&"Point"===c[d].geometry.type?c[d].geometry.coordinates[0]+", "+c[d].geometry.coordinates[1]:null,m.push("<option value='"+j+"' data-lat-lon='"+i+"' data-bbox='"+g+"' data-type='"+c[d].type+"'></option>"),d===e-1&&(m.push("<!--[if lte IE 9]></select><![endif]-->"),l.html(m));a("#wb-geomap-geocode-search-"+b.uniqueId).removeClass("wb-datalist-inited"),a("#wb-geomap-geocode-results-"+b.uniqueId).remove(),a("#wb-al-wb-geomap-geocode-search-"+b.uniqueId).remove(),a("#wb-al-wb-geomap-geocode-search-"+b.uniqueId+"-src").remove(),a("#wb-geomap-geocode-search-"+b.uniqueId).after(l),a("#wb-geomap-geocode-search-"+b.uniqueId).trigger("wb-init.wb-datalist")},"jsonp")},500))})},Z=function(b){a("body").append("<section id='overlay-location-error' class='wb-overlay modal-content overlay-def wb-bar-t bg-danger'><header><h2 class='modal-title'>Geolocation error.</h2></header></section>"),a("#overlay-location-error").trigger("wb-init.wb-overlay");var d=new OpenLayers.Control.Button({title:h.geolocBtn,displayClass:"olButtonGeolocate",eventListeners:{activate:function(){b.geoLocLayer.removeAllFeatures(),b.geolocate.deactivate(),b.geolocate.watch=!0,b.geolocate.activate()},deactivate:function(){b.geoLocLayer.removeAllFeatures(),b.geolocate.deactivate(),b.geolocate.watch=!1}},type:OpenLayers.Control.TYPE_TOGGLE}),e=new OpenLayers.Control.Panel({displayClass:"olPanelGeolocate",createControlMarkup:function(){return c.createElement("button")}});e.addControls([d]),b.geoLocLayer=new OpenLayers.Layer.Vector("geoLocLayer"),b.geolocate=new OpenLayers.Control.Geolocate({type:OpenLayers.Control.TYPE_TOGGLE,bind:!0,watch:!0,geolocationOptions:{enableHighAccuracy:!0,maximumAge:0,timeout:7e3},eventListeners:{locationupdated:function(a){b.geoLocLayer.removeAllFeatures();var c=new OpenLayers.Feature.Vector(a.point,null,{graphicName:"circle",fillColor:"#FF0033",strokeWidth:0,pointRadius:5}),d=new OpenLayers.Feature.Vector(OpenLayers.Geometry.Polygon.createRegularPolygon(new OpenLayers.Geometry.Point(a.point.x,a.point.y),a.position.coords.accuracy/2,40,0),null,{fillOpacity:.3,fillColor:"#FF0033",strokeWidth:0});b.geoLocLayer.addFeatures([c,d]),b.map.zoomToExtent(b.geoLocLayer.getDataExtent()),$(d,b.geoLocLayer)},locationuncapable:function(){a("#overlay-location-error h2.modal-title").text(h.geolocUncapable),a("#overlay-location-error").trigger("open.wb-overlay")},locationfailed:function(){a("#overlay-location-error h2.modal-title").text(h.geolocFailed),a("#overlay-location-error").trigger("open.wb-overlay")}}}),b.map.addLayers([b.geoLocLayer]),b.map.addControls([e,b.geolocate])},$=function(a,c){var d=a.geometry.getCentroid(),e=a.geometry.getBounds(),f=Math.abs((e.right-e.left)/2),g=0,h="up",i=function(){g>16&&clearInterval(b.resizeInterval);var e=.03*f,i=e/f;switch(g){case 4:case 12:h="down";break;case 8:h="up"}"up"!==h&&(i=-Math.abs(i)),a.geometry.resize(1+i,d),c.drawFeature(a),g++};b.resizeInterval=b.setInterval(i,50,d,f)},_=function(b){var c=b.glayers,e=b.map;c.find(".wb-tables").trigger("wb-init.wb-tables"),c.find(".wb-geomap-tabs").trigger("wb-init.wb-tabs"),C(b),b.map.id=b.mapid,o.push(e),setTimeout(function(){b.gmap.find("img").attr("alt",""),a(".olTileImage").attr("alt",""),d.ready(a("#"+b.mapid),i,[e])},2e3),b.map.events.on({moveend:function(){a(".olTileImage").attr("alt",""),a(b.mapid).trigger("wb-updated"+j,[e])}}),o.length===a(j).length&&d.doc.trigger("geomap.ready",[V()])},ab=function(a){var b=W(a.getAttribute("data-map")),c=b.getLayer(a.getAttribute("data-layer"));return[b,c,c.getFeatureById(a.getAttribute("data-feature"))]};k.on("geomap.wb",j,q),k.on("click",".geomap-zoomto",function(b){var c,d,e=b.which,f=b.target;e&&1!==e||(b.preventDefault(),c=f.getAttribute("data-map"),d=ab(f),d[0].zoomToExtent(d[2].geometry.bounds),a("#"+c+" .wb-geomap-map").trigger("setfocus.wb"))}),k.on(d.resizeEvents,function(){if(0!==o.length){var b,c,d,e=V();for(b in e)e.hasOwnProperty(b)&&(c=e[b],d=a(c.div),d.height(.8*d.width()),c.updateSize(),c.zoomToMaxExtent())}}),k.on("change",".geomap-cbx",function(a){var b=a.target,c=ab(b)[2];b.checked?w(c):f.selectControl.unselect(c)}),k.on("change",".geomap-lgnd-cbx",function(b){var d=b.target,e=ab(d)[1],f=d.value,g=c.getElementById("cb_"+f).checked,i=a("table#"+f),j=i.parents(".wb-geomap-table-wrapper"),k=a("#msg_"+f);e.setVisibility(g),0!==k.length?g?k.fadeOut():k.fadeIn():j.after("<div id='msg_"+f+"'><p>"+h.hiddenLayer+"</p></div>"),g?j.fadeIn():j.fadeOut()}),k.on("mouseenter mouseleave focusin focusout",".wb-geomap-map",function(b){var c,d=b.type,e=b.currentTarget,f=W(e.getAttribute("data-map")),g="OpenLayers.Control.KeyboardDefaults",h="OpenLayers.Control.Navigation";f&&(c=e.className.indexOf("active"),"mouseenter"===d||"focusin"===d?c&&(f.getControlsByClass(g)[0].activate(),f.getControlsByClass(h)[0].activate(),a(e).addClass("active")):c||(f.getControlsByClass(h)[0].deactivate(),f.getControlsByClass(g)[0].deactivate(),a(e).removeClass("active")))}),k.on("keydown click",".olPopupCloseBox span",function(a){var b=a.which,c=a.currentTarget;"keydown"===a.type?13===b&&ab(c)[2].popup.hide():b&&1!==b||W(c.getAttribute("data-map")).getControlsByClass("OpenLayers.Control.SelectFeature")[0].unselect(e)})}(jQuery,window,document,wb);